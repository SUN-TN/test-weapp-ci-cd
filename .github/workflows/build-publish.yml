name: PNPM Build on Push
# 触发条件：向本仓库（组织仓库）任意分支推送代码时触发
on:
  push:
    branches: ['main']

jobs:
  build-project:
    # 使用 GitHub 托管的最新 Ubuntu 环境，预装基础工具
    runs-on: ubuntu-latest
    # 步骤按顺序执行，完成代码拉取、环境配置、依赖安装、项目构建
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        # 拉取完整仓库代码，适配多数项目构建需求
        with:
          fetch-depth: 2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          # 指定 Node.js 版本，可根据项目需求修改（如 18、22）
          node-version: 22
          # 缓存 pnpm 依赖，提升后续构建速度
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          # 自动匹配项目 package.json 关联的 pnpm 版本，无关联则用最新稳定版
          version: latest
          # 启用 pnpm 内置依赖缓存
          run_install: false

      - name: Install dependencies
        # CI 环境用 pnpm install --frozen-lockfile，锁定依赖版本，避免版本漂移
        run: pnpm install --frozen-lockfile

      - name: Run build command
        # 执行 package.json 中定义的 build 脚本
        run: pnpm run build:weapp:preview
